# 소개

**gTrade** 프로토콜에 대한 시간 제한 보안 검토가 **pashov**에 의해 수행되었으며, 애플리케이션 스마트 계약 구현의 보안 측면에 중점을 두었습니다.

# 면책 조항

스마트 계약 보안 검토는 취약점의 완전한 부재를 절대 확인할 수 없습니다. 이는 시간, 자원 및 전문 지식이 제한된 노력으로 최대한 많은 취약점을 찾으려고 노력하는 것입니다. 검토 후 100% 보안을 보장할 수 없으며, 검토가 스마트 계약의 문제를 발견할 것이라고 보장할 수도 없습니다. 후속 보안 검토, 버그 바운티 프로그램 및 온체인 모니터링을 강력히 권장합니다.

# **pashov** 소개

Krum Pashov 또는 **pashov**는 독립적인 스마트 계약 보안 연구원입니다. 다양한 프로토콜에서 수많은 보안 취약점을 발견한 그는 보안 연구 및 검토에 시간과 노력을 투자하여 블록체인 생태계와 프로토콜에 기여하기 위해 최선을 다합니다. 이전 작업은 [여기](https://github.com/pashov/audits)에서 확인하거나 Twitter [@pashovkrum](https://twitter.com/pashovkrum)으로 연락할 수 있습니다.

# **gTrade** 소개

`gTrade` 프로토콜은 Gains Network가 개발한 레버리지 거래 플랫폼입니다. 암호화폐 토큰의 경우 최대 150배, 외환의 경우 1000배, 상품의 경우 250배의 레버리지를 허용합니다. 아키텍처는 주로 `GNS` ERC20 토큰과 ERC721 유틸리티 토큰을 중심으로 돌아가며, 두 가지 모두 플랫폼을 사용할 때 감소된 스프레드, 거버넌스 등 다양한 유틸리티를 제공합니다.

프로토콜에 두 가지 새로운 기능이 추가되었습니다:

- 스테이킹: 사용자가 `GNS`를 스테이킹하고 플랫폼의 거래 활동에서 `DAI` 보상을 받을 수 있습니다.
- 보상 처리기(Compensation Handler): 현재는 ERC721 유틸리티 토큰이 사용 중단(deprecated)됨에 따라 해당 토큰 보유자에게 보상하는 데 사용됩니다.

보상 처리기는 또한 사용 중단된 ERC721 토큰이 지금까지 펀드의 수익원이었기 때문에 개발자 펀드(dev fund)에도 보상할 것입니다.

## 관찰 사항

`MINTER_ROLE`을 보유한 사람은 누구나 `GNS` 토큰을 자유롭게 민팅할 수 있습니다.

개발자 펀드 보상은 Arbitrum 네트워크에서만 실행할 수 있습니다.

스테이킹에는 락(lock)이 없으며, 사용자는 같은 블록에서 스테이킹하고 언스테이킹할 수 있습니다.

보상 "분배"는 거래(오픈, 종료, 청산) 기준으로 발생합니다. 이로 인해 분배는 1분에 여러 번 발생하거나 몇 시간 동안 0번 발생할 수 있으므로 타이밍을 맞출 수 없습니다.

## 특권 역할 및 행위자

- `GNS`의 `MINTER_ROLE` - 역할 보유자는 모든 주소에 `GNS` 토큰을 자유롭게 민팅할 수 있으며, `CompensationHandler` 계약이 이 역할을 가집니다.
- 잠금 해제 관리자(Unlock Manager) - 취소 가능한 잠금 해제(revocable unlock) 일정을 생성할 수 있습니다.
- 거버넌스(Governance) - 거버넌스 계정 주소로, `scheduleDevFundUnlock`을 호출하여 개발자 펀드 보상을 위한 클리프 베스팅을 시작하고, 취소 가능한 잠금 해제 일정을 생성/취소하고, `unlockManagers`를 설정할 수 있습니다.
- 사용자(User) - 자신을 위한 취소 불가능한 잠금 해제 일정을 생성할 수 있습니다.

# 심각도 분류

| 심각도 | 영향: 높음 | 영향: 중간 | 영향: 낮음 |
| --- | --- | --- | --- |
| **가능성: 높음** | 치명적 (Critical) | 높음 (High) | 중간 (Medium) |
| **가능성: 중간** | 높음 (High) | 중간 (Medium) | 낮음 (Low) |
| **가능성: 낮음** | 중간 (Medium) | 낮음 (Low) | 낮음 (Low) |

**영향 (Impact)** - 성공적인 공격으로 인한 기술적, 경제적, 평판적 손해

**가능성 (Likelihood)** - 특정 취약점이 발견되고 악용될 확률

**심각도 (Severity)** - 위험의 전반적인 중요성

# 보안 평가 요약

**_검토 커밋 해시_ - [5dfd04b320b6f14ccbabfe2b790987826422b545](https://github.com/GainsNetwork-org/gTrade-contracts/tree/5dfd04b320b6f14ccbabfe2b790987826422b545)**

**_수정 검토 커밋 해시_ - [cf0e7aae00542b479e34ed7a0fbc77c9b0c3084e](https://github.com/GainsNetwork-org/gTrade-contracts/tree/cf0e7aae00542b479e34ed7a0fbc77c9b0c3084e)**

### 범위

다음 스마트 계약이 감사 범위에 포함되었습니다:

- `GNSCompensationHandlerV6_4_1`
- `GNSStakingV6_4_1`

---

# 발견 사항 요약

| ID | 제목 | 심각도 | 상태 |
| --- | --- | --- | --- |
| [M-01] | 불충분한 입력 검증 | 중간 | 수정됨 |
| [L-01] | 구현 계약을 초기화할 수 있음 | 낮음 | 수정됨 |
| [L-02] | 2단계 액세스 제어 전송 패턴 사용 | 낮음 | 수정됨 |

# 상세 발견 사항

# [M-01] 불충분한 입력 검증

## 심각도

**영향:**
높음, 자금이 묶일 수 있기 때문

**가능성:**
낮음, 나쁜 사용자 오류가 필요하기 때문

## 설명

`GNSStakingV6_4_1::createUnlockSchedule`에는 `UnlockScheduleInput calldata _input` 매개변수가 있으며, 구조체의 대부분 필드는 유효한 값 범위 내에 있도록 적절하게 검증됩니다. 문제는 `UnlockScheduleInput`의 `start` 필드가 충분히 검증되지 않아, 타임스탬프를 선택할 때 사용자 오류로 인해 미래(예: 50년 후)로 설정될 수 있다는 것입니다. 이로 인해 메서드로 전송된 `GNS` 자금이 (거의) 영구적으로 잠기게 됩니다.

## 권장 사항

`start` 필드가 너무 먼 미래가 아닌지(예: 최대 1년 후여야 함) 확인하는 검증을 추가하십시오.

# [L-01] 구현 계약을 초기화할 수 있음

`GNSStakingV6_4_1`은 프록시를 통해 사용될 것으로 예상되는 구현 계약입니다. 구현 계약은 직접 사용되어서는 안 되므로 초기화를 허용하지 않는 것이 관례입니다. `GNSStakingV6_4_1`에서 `_disableInitializers()`를 호출하는 빈 생성자(constructor)를 추가하는 것을 고려하십시오.

# [L-02] 2단계 액세스 제어 전송 패턴 사용

`GNSStakingV6_4_1::setGovFund`는 단일 단계 액세스 제어 전송 패턴을 사용합니다. 즉, 현재 `govFund` 계정이 잘못된 주소로 `setGovFund`를 호출하면 이 `govFund` 역할과 이에 의존하는 모든 기능이 영원히 손실됩니다. OpenZeppelin의 [Ownable2Step](https://github.com/OpenZeppelin/openzeppelin-contracts/blob/master/contracts/access/Ownable2Step.sol) 패턴을 따라 해당 작업에 대한 2단계 전송 패턴을 구현하십시오.
