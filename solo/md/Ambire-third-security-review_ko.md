# 소개

Krum Pashov, 또는 **pashov**는 독립 스마트 계약 보안 연구원입니다. 다양한 프로토콜에서 수많은 보안 취약점을 발견했으며, 보안 연구 및 검토에 시간과 노력을 투자하여 블록체인 생태계와 프로토콜에 기여하기 위해 최선을 다하고 있습니다. 그의 이전 작업은 [여기](https://github.com/pashov/audits)에서 확인하거나 Twitter [@pashovkrum](https://twitter.com/pashovkrum)으로 연락할 수 있습니다.

# 면책 조항

스마트 계약 보안 검토는 취약점의 완전한 부재를 절대 확인할 수 없습니다. 이는 시간, 자원 및 전문 지식이 제한된 노력으로 최대한 많은 취약점을 찾으려고 노력하는 것입니다. 검토 후 100% 보안을 보장할 수 없으며, 검토가 스마트 계약의 문제를 발견할 것이라고 보장할 수도 없습니다. 후속 보안 검토, 버그 바운티 프로그램 및 온체인 모니터링을 강력히 권장합니다.

# 소개

**Pashov** 프로토콜에 대한 시간 제한 보안 검토가 **pashov**에 의해 수행되었으며, 애플리케이션의 스마트 계약 구현의 보안 측면에 중점을 두었습니다.

# Ambire 소개

**이전 보안 검토에서 복사됨**

Ambire는 스마트 지갑 프로토콜입니다. 사용자는 자신 또는 "권한(privileges)"을 가진 다른 주소가 제어하는 지갑(계정)을 갖습니다. 사용자는 트랜잭션 번들을 오프체인에서 서명할 수 있으며 누구나 온체인에서 이를 실행할 수 있습니다. EIP712, Schnorr, Multisig 등 다양한 서명 체계가 허용됩니다. 이 프로토콜은 반사실적(counterfactual) 방식으로 작동하며, 이는 사용자 지갑이 첫 번째 트랜잭션에서만 배포됨을 의미합니다. 실제 배포는 지갑 스마트 계약에 대한 EIP1167 최소 프록시입니다.

`Ambire` 프로토콜은 "외부 서명 검증기(external signature validator)" 옵션을 추가하여 서명 검증기 옵션을 확장했습니다. 그러한 옵션 중 하나는 `DKIMRecoverySigValidator`이며, 이는 기본적으로 이메일을 사용하여 스마트 지갑에 대한 액세스를 복구하는 방법입니다. 보조 키와 이메일에 대한 액세스 및 제어 권한이 있지만 기본 키를 분실한 경우 계정에 대한 액세스를 즉시 복구할 수 있습니다. 둘 중 하나에 대한 액세스/제어 권한을 잃은 경우에도 복구를 대기열에 넣을 수 있지만 타임락(timelock)이 지날 때까지 기다려야 합니다.

**계속됨**

Ambire는 `validateUserOp` 기능을 통해 `AmbireAccount` 계약에 ERC4337 지원을 추가했습니다. 이 구현에는 계정에서 4337을 쉽게 활성화할 수 있는 특별한 주의 사항이 있습니다. 또한 사용자가 트랜잭션에 대한 가스 비용을 위임할 수 있는 새로운 `AmbirePaymaster` 계약이 있습니다.

[ERC4337 표준](https://eips.ethereum.org/EIPS/eip-4337)

## 관찰 사항

이 프로토콜은 `AmbireAccount` 계약이 계정에서 `executeMultiple`을 호출하려고 할 때 `UserOperation` 서명 필드를 사용하지 않도록 허용하는 특별한 ERC4337 구현을 갖추고 있습니다.

`AmbirePaymaster` 계약은 스토리지에서 읽고/쓰지 않으며 `postOp` 구현이 없기 때문에 ERC4337 시스템에 스테이킹하는 기능을 생략합니다.

## 특권 역할 및 행위자

- 페이마스터 (Paymaster) - 사용자 트랜잭션 가스 비용을 충당할 수 있게 함

# 위험 분류

| 심각도 | 영향: 높음 | 영향: 중간 | 영향: 낮음 |
| --- | --- | --- | --- |
| **가능성: 높음** | 치명적 (Critical) | 높음 (High) | 중간 (Medium) |
| **가능성: 중간** | 높음 (High) | 중간 (Medium) | 낮음 (Low) |
| **가능성: 낮음** | 중간 (Medium) | 낮음 (Low) | 낮음 (Low) |

## 영향 (Impact)

- 높음 - 프로토콜 자산의 상당한 물질적 손실을 초래하거나 사용자 그룹에 심각한 해를 끼칩니다.

- 중간 - 프로토콜 자산의 중간 정도의 물질적 손실을 초래하거나 사용자 그룹에 적당한 해를 끼칩니다.

- 낮음 - 프로토콜 자산의 경미한 물질적 손실을 초래하거나 소규모 사용자 그룹에 해를 끼칩니다.

## 가능성 (Likelihood)

- 높음 - 온체인 조건을 모방하는 합리적인 가정으로 공격 경로가 가능하며, 공격 비용이 도난당하거나 손실될 수 있는 자금의 양에 비해 상대적으로 낮습니다.

- 중간 - 조건부로 인센티브가 주어지는 공격 벡터일 뿐이지만 여전히 발생 가능성이 상대적으로 높습니다.

- 낮음 - 너무 많거나 너무 그럴듯하지 않은 가정이 있거나 인센티브가 거의 또는 전혀 없는 공격자의 상당한 지분을 필요로 합니다.

## 심각도 수준에 따른 조치 필요

- 치명적 - 가능한 한 빨리 수정해야 함 (이미 배포된 경우)

- 높음 - 수정해야 함 (아직 배포되지 않은 경우 배포 전)

- 중간 - 수정해야 함 (Should fix)

- 낮음 - 수정할 수 있음 (Could fix)

# 보안 평가 요약

**_검토 커밋 해시_ - [da3ba641a004d1f0143a20ddde48049b619431ad](https://github.com/AmbireTech/ambire-common/tree/da3ba641a004d1f0143a20ddde48049b619431ad)**

**_수정 검토 커밋 해시_ - [62ba7dc8eaca4c1a1f66a777aecc475735449ef3](https://github.com/AmbireTech/ambire-common/tree/62ba7dc8eaca4c1a1f66a777aecc475735449ef3)**

# 발견 사항

# [L-01] 헤더를 검증하는 DKIM 로직이 이상한 케이스를 허용함

`DKIMRecoverySigValidator`의 `_verifyHeaders` 메서드는 이제 다음 두 가지 이상 징후를 허용합니다:

1. 두 개의 `\r\n` 표현식 사이에 추가 텍스트가 있는 유효한 헤더 집합
2. 재정렬된 `subject`, `to` 및 `from` 헤더가 이제 허용됨 - 이전에는 `from`, `to`, `subject` 순서가 예상되었습니다.

코드를 순차 상태 머신으로 변경하여 기본적으로 헤더의 텍스트 순서를 강제할 수 있습니다.

# [L-02] `AmbirePaymaster`에 `withdrawTo` 기능 없음

이더리움의 ERC4337 구현에는 페이마스터가 보증금을 인출할 수 있도록 하는 `withdrawTo` 기능이 있는 `StakeMaster` 계약이 [여기](https://github.com/eth-infinitism/account-abstraction/blob/674b1f51164e641a18d5c141895bab9c96a68e9d/contracts/core/StakeManager.sol#L137-L148)에서 볼 수 있듯이 있습니다. 문제는 `AmbirePaymaster`가 이 기능을 호출하는 직접적인 방법을 구현하지 않지만, 대신 `relayer` 주소에 대해 허용된 임의 호출 기능을 가지고 있다는 것입니다. 해당 기능을 통해 `withdrawTo` 메서드를 호출할 수 있지만, `call` 메서드의 NatSpec에는 다음과 같은 주석이 있습니다:

```solidity
* @notice  This method can be used to withdraw stuck tokens or airdrops
```

이는 그렇게 하도록 의도되지 않았음을 의미합니다. 다른 용도로도 `call`을 사용할 계획이라면 `value` 인수를 사용하지만 계약에 ETH를 받을 방법이 없으므로 `payable`로 만드는 것을 고려하십시오.
