# 소개

**pashov**가 **Solidly V3 AMM**에 대해 시간 제한이 있는 보안 검토를 수행했으며, 애플리케이션의 스마트 계약 구현의 보안 측면에 중점을 두었습니다.

# 면책 조항

스마트 계약 보안 검토는 취약점의 완전한 부재를 절대 보장할 수 없습니다. 이는 시간, 자원 및 전문 지식에 제한이 있는 노력으로, 가능한 한 많은 취약점을 찾으려고 노력합니다. 검토 후 100% 보안을 보장할 수 없으며, 검토가 귀하의 스마트 계약에서 문제를 발견할 것이라고 보장할 수도 없습니다. 후속 보안 검토, 버그 바운티 프로그램 및 온체인 모니터링을 강력히 권장합니다.

# **pashov** 소개

Krum Pashov, 또는 **pashov**는 독립적인 스마트 계약 보안 연구원입니다. 다양한 프로토콜에서 수많은 보안 취약점을 발견했으며, 보안 연구 및 검토에 시간과 노력을 투자하여 블록체인 생태계와 프로토콜에 기여하기 위해 최선을 다하고 있습니다. 그의 이전 작업은 [여기](https://github.com/pashov/audits)에서 확인하거나 Twitter [@pashovkrum](https://twitter.com/pashovkrum)으로 연락하세요.

# **Solidly V3 AMM** 소개

Solidly V3 AMM은 Uniswap V3 포크입니다. 목표는 Uniswap의 구현보다 가스 효율성이 높고 다른 수수료 메커니즘을 사용하는 것입니다. Solidly V3와 Uniswap V3의 주요 차이점은 다음과 같습니다.

- 풀의 스왑 수수료는 허가된 `feeSetter` 역할로 동적으로 조정될 수 있습니다.
- LP는 온체인에서 수수료를 직접 축적하지 않으며, 모든 수수료는 허가된 `feeCollector` 역할로 이동한 다음 오프체인에서 처리되어 온체인 청구를 위한 머클 트리를 생성합니다.
- 오라클 로직이 완전히 제거되었습니다.
- 스왑, LP 민트 및 LP 소각에 대한 콜백이 없으며, `flash`에서만 있습니다.

## 관찰 사항

Uniswap V3에는 두 가지 유형의 수수료가 있었습니다.

1. LP에게 가는 스왑 수수료
2. 스왑 수수료의 일정 비율인 프로토콜 수수료, Uniswap Treasury로 전송됨 (기본적으로 0으로 설정됨)

Solidly V3 AMM에는 단 한 가지 유형의 수수료만 있습니다 - `feeCollector` 역할에 의해 수집되는 스왑 수수료입니다. 팀에 따르면 이 주소는 `RewardsDistributor` 계약이 될 것이며 예상 소스 코드는 [여기](https://github.com/SolidlyV3/v3-rewards/blob/dev/contracts/RewardsDistributor.sol)에서 볼 수 있습니다. RewardDistributor의 허가된 역할은 주기적으로 머클 루트를 업데이트하여 LP와 유권자가 얻은 최신 보상을 반영합니다.

`SolidlyV3Factory` 소유자와 `RewardsDistributor` 소유자가 수수료 분배에 대한 통제권을 가지고 있으므로, (팀에 따르면) 타임락 + 다중 서명 뒤에 구현되더라도 악의적이거나 타협된 다중 서명이 스왑 수수료를 가져갈 수 있습니다.

동일한 틱 간격 값으로 여러 A 및 B 토큰 풀을 배포할 수는 없지만, 동일한 스왑 수수료 값으로 여러 개의 해당 풀을 배포할 수는 있습니다.

## 특권 역할 및 행위자

- Factory owner - 새로운 `fee` + `tickSpacing` 구성으로 풀 생성을 활성화할 수 있으며(Uniswap과 동일), 수수료 설정자 및 수집자 역할을 부여/취소할 수도 있습니다.
- Fee setter - 모든 풀의 수수료를 최대 10%까지 업데이트할 수 있습니다.
- Fee collector - 모든 풀에 대해 누적된 모든 스왑 수수료를 수집할 수 있습니다.

# 심각도 분류

| 심각도 | 영향: 높음 | 영향: 중간 | 영향: 낮음 |
| --- | --- | --- | --- |
| **가능성: 높음** | 치명적 | 높음 | 중간 |
| **가능성: 중간** | 높음 | 중간 | 낮음 |
| **가능성: 낮음** | 중간 | 낮음 | 낮음 |

**영향(Impact)** - 성공적인 공격의 기술적, 경제적, 평판적 손해
**가능성(Likelihood)** - 특정 취약점이 발견되고 악용될 확률
**심각도(Severity)** - 위험의 전반적인 중요도

# 보안 평가 요약

**_검토 커밋 해시_ - [819283d2e400b697413b35771bd4957863d1fd71](https://github.com/SolidlyV3/v3-core/tree/819283d2e400b697413b35771bd4957863d1fd71)**

**_수정 검토 커밋 해시_ - [f8201ab299f976a8e0b0e0539e5a907cc83236bd](https://github.com/SolidlyV3/v3-core/tree/f8201ab299f976a8e0b0e0539e5a907cc83236bd)**

### 범위

다음 스마트 계약들이 감사 범위에 포함되었습니다:

- `SolidlyV3Factory`
- `SolidlyV3Pool`
- `SolidlyV3PoolDeployer`
- `libraries/Position`
- `libraries/Status`
- `libraries/Tick`

---

# 결과 요약

| ID | 제목 | 심각도 | 상태 |
| --- | --- | --- | --- |
| [M-01] | 풀이 비표준 ERC20 토큰과 호환되지 않음 | 중간 | 수정됨 |
| [M-02] | 프로토콜 소유자가 획득한 스왑 수수료에 대한 통제권을 가짐 | 중간 | 인지함 |
| [L-01] | 수수료 값이 생성자에서 검증되지 않음 | 낮음 | 인지함 |

# 상세 결과

# [M-01] 풀이 비표준 ERC20 토큰과 호환되지 않음

## 심각도

**영향:**
중간, 앱에서 가능한 풀을 제한하고 일부 특수한 경우 자금 손실을 초래할 수 있기 때문

**가능성:**
중간, `USDT`와 같은 일부 토큰은 드물지 않기 때문

## 설명

Solidly V3 AMM 코드는 전송 전후의 잔액 확인과 `TransferHelper` 라이브러리를 제거하고 ERC20의 `transfer` 및 `transferFrom` 메서드를 직접 호출합니다. 이는 세 가지 다른 유형의 토큰에서 문제가 될 것입니다.

1. `USDT` 및 `BNB` 토큰은 `transfer` 시 `bool`을 반환하지 않습니다. 즉, 해당 토큰 풀에 유동성을 추가하는 트랜잭션은 직접 되돌아가(revert) 애플리케이션에서 가능한 풀의 제한을 초래합니다.
2. `ZRX` 및 `EURS` 토큰은 실패 시 되돌리지(revert) 않고 대신 `false`를 반환합니다. 메서드의 반환 값이 확인되지 않으므로 `transfer` 또는 `transferFrom`이 실패하면 자금 손실이 발생할 수 있습니다.
3. 일부 토큰에는 전송 수수료가 있으며(예: `STA`, `PAXG`) 예를 들어 `USDT`에는 수수료 메커니즘이 있지만 현재 꺼져 있습니다. 이러한 토큰은 풀과 올바르게 작동하지 않으며 자금 손실로 이어질 수 있습니다.

## 권장 사항

문서에는 수수료 부과(fee-on-transfer) 토큰이 지원되지 않는다고 명시해야 하지만, 애플리케이션은 다른 토큰과도 호환되지 않습니다. 이를 문서에 명시하거나 `TransferHelper` 라이브러리 사용을 고려하고, 전송 전후 잔액 확인을 다시 추가하십시오.

## 논의

**pashov:** `transfer` 시 `bool`을 반환하지 않거나 실패 시 되돌리지 않는 토큰이 이제 올바르게 처리됩니다. 수수료 부과 토큰은 명시적으로 지원되지 않습니다.

# [M-02] 프로토콜 소유자가 획득한 스왑 수수료에 대한 통제권을 가짐

## 심각도

**영향:**
높음, LP의 수익 손실로 이어질 수 있기 때문

**가능성:**
낮음, 타협되거나 악의적인 소유자가 필요하기 때문

## 설명

Solidly V3 AMM에서 스왑 수수료는 `feeCollector` 역할이 부여된 계정에서 수집할 수 있습니다. `SolidlyV3Factory`는 계정에 이 역할을 부여하고 취소할 수 있습니다. 초기 역할 보유자는 `RewardsDistributor` 계약으로 설정될 것으로 예상됩니다(예상 소스 코드는 [여기](https://github.com/SolidlyV3/v3-rewards/blob/dev/contracts/RewardsDistributor.sol)에서 볼 수 있음). 해당 계약에서 허가된 `owner`는 수수료를 청구할 수 있는 사람(및 금액)을 보여주는 머클 루트를 설정할 수 있습니다.

소유자가 LP로부터 스왑 수수료를 유용할 수 있는 여러 가지 옵션이 있습니다.

1. `SolidlyV3Factory` 소유자는 자신이나 자신이 제어하는 다른 주소가 `feeCollector` 역할을 갖도록 설정한 다음 모든 수수료를 청구할 수 있습니다.
2. `RewardsDistributor` 소유자는 자신의 주소나 자신이 제어하는 다른 주소만 보유하는 청구 가능한 보상에 대한 머클 루트를 설정한 다음 모든 수수료를 청구할 수 있습니다.
3. `RewardsDistributor` 소유자는 머클 루트를 절대 설정하지 않아 수수료가 애플리케이션에 영원히 갇히게 할 수 있습니다.

## 권장 사항

팀은 모든 허가된 주소가 다중 서명 및 Timelock 계약 뒤에 있을 것이라고 전달했지만, 이는 여전히 타협되거나 악의적인 소유자가 악용할 수 있는 공격 벡터입니다. Timelock에는 24시간 지연이 있는데, 이는 사용자가 청구되지 않은 수익을 청구하기에는 너무 짧을 수 있습니다. 또한 머클 루트가 설정되어 그들이 전혀 청구할 수 없도록 할 수도 있습니다. 여기서 보상을 청구하기 위한 다른 메커니즘을 생각할 수 있습니다.

## 논의

**Solidly Team** 프로토콜 설계 사양에 따릅니다. 악의적인 거버넌스의 경우 타임락 계약(OpenZeppelin)이 사용자에게 미리 경고합니다. 인지함(Acknowledged).

# [L-01] 수수료 값이 생성자에서 검증되지 않음

풀 수수료 값은 `setFee` 메서드와 `enableFeeAmount`에서도 `require(fee <= 100000);`로 확인되지만, 이 확인은 `SolidlyV3Pool` 생성자에서 생략되어 있어 초기 수수료를 더 큰 값으로 설정할 수 있습니다. 이 확인은 `SolidlyV3Pool`의 생성자에도 있어야 합니다.

## 논의

**Solidly Team** 인지함(Acknowledged).

