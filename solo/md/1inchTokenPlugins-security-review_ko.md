# 소개

**1inch Token Plugins** 프로토콜에 대한 시간 제한 보안 검토가 **pashov**에 의해 수행되었으며, 애플리케이션의 스마트 계약 구현의 보안 측면에 중점을 두었습니다.

# 면책 조항

스마트 계약 보안 검토는 취약점의 완전한 부재를 절대 확인할 수 없습니다. 이는 시간, 자원 및 전문 지식이 제한된 노력으로 최대한 많은 취약점을 찾으려고 노력하는 것입니다. 검토 후 100% 보안을 보장할 수 없으며, 검토가 스마트 계약의 문제를 발견할 것이라고 보장할 수도 없습니다. 후속 보안 검토, 버그 바운티 프로그램 및 온체인 모니터링을 강력히 권장합니다.

# **pashov** 소개

Krum Pashov, 또는 **pashov**는 독립 스마트 계약 보안 연구원입니다. 다양한 프로토콜에서 수많은 보안 취약점을 발견했으며, 보안 연구 및 검토에 시간과 노력을 투자하여 블록체인 생태계와 프로토콜에 기여하기 위해 최선을 다하고 있습니다. 그의 이전 작업은 [여기](https://github.com/pashov/audits)에서 확인하거나 Twitter [@pashovkrum](https://twitter.com/pashovkrum)으로 연락할 수 있습니다.

# **1inch Token Plugins** 소개

Token Plugins는 특정 플러그인에 옵트인(opt-in)한 사용자의 잔액을 외부에서 추적하여 일반 ERC20 토큰의 기능을 향상시키는 ERC20 시스템입니다. 기본적인 사용 사례 예시는 토큰을 스마트 계약으로 실제로 전송하지 않고 토큰 지분을 추적하려는 경우입니다. 또 다른 예시는 파밍/스테이킹입니다. 플러그인을 지원하는 토큰을 보유한 사용자는 지갑에서 파밍/스테이킹 계약으로 토큰을 전송할 필요 없이 플러그인에 옵트인(`addPlugin` 메서드 호출)하기만 하면 됩니다. 이렇게 하면 모듈성이 달성되고, 사용자는 보유한 토큰을 지갑에서 떠나보내지 않고도 토큰에 대한 다양한 부가 사용 사례에 참여할 수 있습니다.

플러그인은 `Plugin` 계약을 상속받은 다음 대상 `token`과 `updateBalances` 동작을 지정하여 구현됩니다. `ERC20Plugins` 계약은 외부 플러그인 추가 및 제거를 지원하기 위해 토큰이 상속해야 하는 계약이거나, ERC20 래퍼(wrapper) 계약과 조합하여 사용하는 또 다른 옵션입니다.

[이전 보안 감사 보고서](https://github.com/1inch/1inch-audits/tree/master/Fusion%20mode%20and%20Token-plugins)

## 관찰 사항

`_updateBalances` 메서드는 사용자 제어 `plugin` 주소에 대해 저수준 `call`을 수행합니다. 또한 `"memory-safe"` 주석이 표시된 `assembly` 블록이 있습니다. `ERC20Plugins`에서 `_updateBalances` 외부 호출이 실패하면 가스 부족으로 인한 실패가 아닌 한 트랜잭션이 되돌려지지 않습니다.

## 특권 역할 및 행위자

플러그인 설계에는 특권 역할이 없으며, 자신의 플러그인을 추가하고 제거할 수 있는 일반 사용자만 있습니다. 사용자는 또한 `ERC20Plugins` 계약이 자신의 `Plugin` 계약을 호출하도록 할 수 있습니다.

# 심각도 분류

| 심각도 | 영향: 높음 | 영향: 중간 | 영향: 낮음 |
| --- | --- | --- | --- |
| **가능성: 높음** | 치명적 (Critical) | 높음 (High) | 중간 (Medium) |
| **가능성: 중간** | 높음 (High) | 중간 (Medium) | 낮음 (Low) |
| **가능성: 낮음** | 중간 (Medium) | 낮음 (Low) | 낮음 (Low) |

**영향 (Impact)** - 성공적인 공격의 기술적, 경제적, 평판적 손상

**가능성 (Likelihood)** - 특정 취약점이 발견되고 악용될 확률

**심각도 (Severity)** - 위험의 전반적인 임계도

# 보안 평가 요약

**_검토 커밋 해시_ - [585cad4891c3de7bd8692d366740ae72595fdefc](https://github.com/1inch/token-plugins/tree/585cad4891c3de7bd8692d366740ae72595fdefc)**

**수정 사항이 구현되지 않았습니다.**

### 범위

다음 스마트 계약이 감사 범위에 포함되었습니다:

- `interfaces/**`
- `libs/ReentrancyGuard`
- `Plugin`
- `ERC20Plugins`

---

# 발견 사항 요약

| ID | 제목 | 심각도 | 상태 |
| --- | --- | --- | --- |
| [L-01] | `immutable` 값을 가스 제한으로 사용하는 것은 위험할 수 있음 | 낮음 | 인지됨 |
| [L-02] | 결함이 있는 컴파일러 버전을 사용할 가능성 | 낮음 | 인지됨 |

# 상세 발견 사항

# [L-01] `immutable` 값을 가스 제한으로 사용하는 것은 위험할 수 있음

`pluginCallGasLimit`은 `ERC20Plugins`의 생성자에서 설정되는 값이며 `immutable`입니다. 이 값은 외부 저수준 호출이 사용할 수 있는 허용된 가스를 제한하는 데 사용됩니다. 이 문제점은 이전 이더리움 하드포크가 일반적으로 사용되는 opcode의 가스 비용을 변경했다는 것입니다(예: `EIP-150`). 이러한 일이 다시 발생하면 `pluginCallGasLimit` 값이 계약에 필요한 작업을 실행하기에 불충분해질 수 있습니다. 값을 변경 가능(mutable)하게 만들거나 완전히 제거하는 것을 고려하십시오.

# [L-02] 결함이 있는 컴파일러 버전을 사용할 가능성

Solidity 버전 0.8.13 및 0.8.14에는 메모리에 쓰는 어셈블리 블록과 관련된 보안 취약점이 있으며, 이는 `ERC20Plugins` 계약에 존재합니다. 이 문제는 버전 0.8.15에서 수정되었으며 [여기](https://soliditylang.org/blog/2022/06/15/solidity-0.8.15-release-announcement/)에 설명되어 있습니다. 문제가 레거시 최적화 도구(사용 중인 yul IR 파이프라인이 아님)에 있지만, 최신 Solidity 버전(0.8.21)을 강제하거나 최소한 OpenZeppelin(0.8.19)과 같은 다른 인기 있는 라이브러리 코드에서 강제하는 버전을 사용하는 것이 여전히 올바릅니다. 전체 코드베이스에 적용됩니다.

```diff
-pragma solidity ^0.8.0;
+pragma solidity ^0.8.19;
```
